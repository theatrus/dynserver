#!/usr/bin/make -f

export DH_VERBOSE = 1
export CARGO_HOME = $(CURDIR)/debian/cargo

# Enable all hardening options
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

# Set optimization flags for release build
export CARGO_PROFILE_RELEASE_LTO = true
export CARGO_PROFILE_RELEASE_CODEGEN_UNITS = 1

%:
	dh $@

override_dh_auto_configure:
	# Create cargo home directory
	mkdir -p $(CARGO_HOME)

override_dh_auto_build:
	# Build the Rust binary in release mode
	cargo build --release --locked

override_dh_auto_test:
	# Run tests
	cargo test --release --locked

override_dh_auto_install:
	# Install the binary
	install -D -m 755 target/release/tenrankai debian/tenrankai/usr/bin/tenrankai
	
	# Install systemd service file
	install -D -m 644 tenrankai.service debian/tenrankai/lib/systemd/system/tenrankai.service
	
	# Install example configuration
	install -D -m 644 config.toml.example debian/tenrankai/etc/tenrankai/config.toml.example
	
	# Install logrotate configuration
	install -D -m 644 debian/logrotate debian/tenrankai/etc/logrotate.d/tenrankai
	
	# Install templates
	mkdir -p debian/tenrankai/usr/share/tenrankai/templates
	cp -r templates/* debian/tenrankai/usr/share/tenrankai/templates/
	
	# Install static files
	mkdir -p debian/tenrankai/usr/share/tenrankai/static
	cp -r static/* debian/tenrankai/usr/share/tenrankai/static/
	
	# Create directories for runtime data
	mkdir -p debian/tenrankai/var/lib/tenrankai
	mkdir -p debian/tenrankai/var/log/tenrankai
	
	# Create config directory
	mkdir -p debian/tenrankai/etc/tenrankai

override_dh_auto_clean:
	# Clean cargo build artifacts
	cargo clean || true
	rm -rf $(CARGO_HOME)

override_dh_fixperms:
	dh_fixperms
	# Ensure correct permissions for sensitive directories
	chmod 750 debian/tenrankai/etc/tenrankai
	chmod 750 debian/tenrankai/var/lib/tenrankai
	chmod 755 debian/tenrankai/var/log/tenrankai